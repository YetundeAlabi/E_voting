{% extends 'base.html'%}
{%block main%}

  <main id="main" class="main">

    <div class="pagetitle">
      <h1>Create Voters</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">poll</a></li>
          <li class="breadcrumb-item">Forms</li>
          <li class="breadcrumb-item active">Elements</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

<div class="card">
    <div class="card-body">
      <h5 class="card-title">Voter Form</h5>

      <!-- Vertical Form -->
      <form class="row g-3" id="voter-form">
        <div class="col-12">
          <label for="inputName" class="form-label">First Name</label>
          <input type="text" class="form-control" id="firstName">
        </div>
        <div class="col-12">
          <label for="inputName" class="form-label">Last Name</label>
          <input type="text" class="form-control" id="lastName">
        </div>
        <div class="col-12">
          <label for="inputEmail4" class="form-label">Email address</label>
          <input type="email" class="form-control" id="inputEmail">
        </div>
        <div class="col-12">
          <label for="phone_number" class="form-label">Phone number</label>
          <input type="tel" class="form-control" id="inputPhone" placeholder="+234">
        </div>
        <div class="row mb-3">
        <label for="poll-select" class="col-sm-2 col-form-label">Poll:</label>
        <div class="col-sm-10">
        <select class="form-select" aria-label="Default select example" id="poll-select" required>
        <option value="">Select a poll</option>
      <!-- Dynamically populate poll options using JavaScript -->
    </select>
 </div>
</div>
        <div class="text-center">
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form><!-- Vertical Form -->

    </div>
</div>
{%endblock%}
{%block script%}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }
    const csrftoken = getCookie("csrftoken");

    const voterForm = document.getElementById("voter-form");
    const firstName = document.getElementById("firstName");
    const lastName = document.getElementById("lastName");
    const emailInput = document.getElementById("emailInput");
    const phone_number = document.getElementById("phone_number");

    
    voterForm.addEventListener("submit", (event) => {
      event.preventDefault();
      var url = "http://127.0.0.1:8000/polls/";
      
      fetch(url)
      .then(function(response) {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error("Failed to fetch polls.");
        }
      })
      .then(function(data) {
        var pollSelect = document.getElementById("poll-select");
        data.forEach(function(poll) {
          var option = document.createElement("option");
          option.value = poll.id;
          option.textContent = poll.name;
          pollSelect.appendChild(option);
        });
      })
      .catch(function(error) {
        console.log(error);
      });
  
    document.getElementById("voter-form").addEventListener("submit", function(event) {
      event.preventDefault(); // Prevent the form from submitting normally
  
      // Get form input values
      var firstName = document.getElementById("firstName").value;
      var lastName = document.getElementById("lastName").value;
      var email = document.getElementById("inputEmail").value;
      var phoneNumber = document.getElementById("inputPhone").value;
      var pollId = document.getElementById("poll-select").value;

      var voterData = {
        first_name: firstName,
        last_name: lastName,
        email: email,
        phone_number: phoneNumber,
        poll: pollId
      };
      try {
        const config = {
          method: 'POST',
          headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken,
              'Authorization': `Bearer ${window.localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify(voterdata)
      }
        const response = await fetch(`http://127.0.0.1:8000/api/polls/${pollId}/voters/`, config)
        
        if (response.ok) {
          const data = await response.json()
          alert("voter created successfully.");
          console.log(data)
        } else {
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            (response.status) (response.message)
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        }
      } catch (error) {
        alert("An error occurred while creating the voting poll.");
        console.log(error);
      }
  });
})

</script>
{%endblock%}