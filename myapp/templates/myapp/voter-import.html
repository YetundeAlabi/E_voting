{%extends 'base.html'%}

{%block main%}

<div class="row mb-3">
    <label for="poll-select" class="col-sm-2 col-form-label">Poll:</label>
    <div class="col-sm-10">
    <select class="form-select" aria-label="Default select example" id="poll-select" required>
      <option value="">Select a poll</option>
      <!-- Dynamically populate poll options using JavaScript -->
    </select>
 </div>
</div>

<div class="row mb-3">
  <label for="file" class="col-sm-2 col-form-label">File Upload</label>
  <div class="col-sm-10">
    <input class="form-control" type="file" id="formFile">
  </div>
  <div class="row mb-3">
    <div class="col-sm-10">
      <button type="submit" class="btn btn-primary">Import Voter</button>
    </div>
  </div>
{%endblock%}
{%block script%}
<script>
  var baseUrl = window.location.protocol + "//" + window.location.host;
  console.log(baseUrl);

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

    const csrftoken = getCookie("csrftoken");
    const pollSelect = document.getElementById("poll-select");
    const importButton = document.getElementById("import-button");

    fetch("http://127.0.0.1:8000/api/polls/")
      .then(function(response) {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error("Failed to fetch polls.");
        }
      })
      .then(function(data) {
        var pollSelect = document.getElementById("poll-select");
        data.forEach(function(poll) {
          var option = document.createElement("option");
          option.value = poll.id;
          option.textContent = poll.name;
          pollSelect.appendChild(option);
        });
      })
      .catch(function(error) {
        console.log(error);
      });
  
      importButton.addEventListener("click", function(){
      // Get the file input element
      var fileInput = document.getElementById("formFile");

      // Create a new FormData object
      var formData = new FormData();

      // Append the file to the FormData object
      formData.append("file", fileInput.files[0]);

      // Make the POST request with the FormData object
      fetch("http://polls/<int:pk>/import/", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrftoken,
          "Authorization":`Bearer ${window.localStorage.getItem('accessToken')}`
        },
        body: formData
      })
        .then(function(response) {
          if (response.ok) {
            // File uploaded successfully
            console.log("File uploaded successfully!");
          } else {
            // Error in uploading file
            console.log("Failed to upload file.");
          }
        })
        .catch(function(error) {
          // Error in making the request
          console.log("An error occurred while uploading the file.");
          console.log(error);
        });
     }

</script>
{%endblock%}