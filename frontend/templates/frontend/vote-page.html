{%load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Dashboard - NiceAdmin Bootstrap Template</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="{% static 'assets/img/favicon.png' %}" rel="icon">
  <link href="{% static 'assets/img/apple-touch-icon.png' %}" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="{% static 'assets/vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/boxicons/css/boxicons.min.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/quill/quill.snow.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/quill/quill.bubble.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/remixicon/remixicon.css' %}" rel="stylesheet">
  <link href="{% static 'assets/vendor/simple-datatables/style.css' %}" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="{% static 'assets/css/style.css' %}" rel="stylesheet">

  
</head>

  
  <!-- ======= Footer ======= -->
  <footer id="footer" class="footer">
    <div class="copyright">
      &copy; Copyright <strong><span>NiceAdmin</span></strong>. All Rights Reserved
    </div>
    <div class="credits">
      <!-- All the links in the footer should remain intact. -->
      <!-- You can delete the links only if you purchased the pro version. -->
      <!-- Licensing information: https://bootstrapmade.com/license/ -->
      <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/ -->
      Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="{% static 'assets/vendor/apexcharts/apexcharts.min.js' %}"></script>
  <script src="{% static 'assets/vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script src="{% static 'assets/vendor/chart.js/chart.umd.js' %}"></script>
  <script src="{% static 'assets/vendor/echarts/echarts.min.js' %}"></script>
  <script src="{% static 'assets/vendor/quill/quill.min.js' %}"></script>
  <script src="{% static 'assets/vendor/simple-datatables/simple-datatables.js' %}"></script>
  <script src="{% static 'assets/vendor/tinymce/tinymce.min.js' %}"></script>
  <script src="{% static 'assets/vendor/php-email-form/validate.js' %}"></script>

  <!-- Template Main JS File -->
  <script src="{% static 'assets/js/main.js' %}"></script>
  {%block script%}{%endblock%}
  <script>
    var baseUrl = window.location.protocol + "//" + window.location.host;
    console.log(baseUrl);
    
    var url = window.location.href;
    pollId = {{ poll_id }}
    voterId = {{ voter_id }}

    console.log(pollId); // Output: 2
    console.log(voterId); // Output: 3
  
    async function fetchPolls() {
      
      try {
        const response = await fetch('http://127.0.0.1:8000/api/polls/{pollId}/voters/{voterId}/');
        console.log("got here")
        const poll = await response.json();
        if (response.ok) {
          console.log('status code:', response.status); // 👉️ 200
        } else if (response.status === 404) {
          window.location.href = 'poll_result.html';
          return;
        } else {
          throw new Error(`Error! status: ${response.status}`);
        }
    
        const currentTime = new Date();
        const pollStartTime = new Date(poll.start_time);
    
        if (pollStartTime > currentTime && poll.total_votes === 0) {
          // Display the page indicating the poll will start at poll.start_time
          const pollStartPage = document.createElement('div');
          pollStartPage.textContent = `The poll will start at ${poll.start_time}`;
          pollListContainer.appendChild(pollStartPage);
          return;
        }
        
          const pollDiv = document.createElement('div');
          
          // Create poll name label
          const pollNameLabel = document.createElement('label');
          pollNameLabel.textContent = 'Name: ' + poll.name;
          pollDiv.appendChild(pollNameLabel);
          
          // Create poll description label
          const pollDescriptionLabel = document.createElement('label');
          pollDescriptionLabel.textContent = 'Description: ' + poll.description;
          pollDiv.appendChild(pollDescriptionLabel);
          
          // Create poll start time label
          const pollStartTimeLabel = document.createElement('label');
          pollStartTimeLabel.textContent = 'Start Time: ' + poll.start_time;
          pollDiv.appendChild(pollStartTimeLabel);
          
          // Create poll end time label
          const pollEndTimeLabel = document.createElement('label');
          pollEndTimeLabel.textContent = 'End Time: ' + poll.end_time;
          pollDiv.appendChild(pollEndTimeLabel);
          
          // Get the candidate list for the poll
          const candidateList = poll.candidates;
          
          // Create radio buttons for each candidate
          candidateList.forEach((candidate) => {
            const candidateDiv = document.createElement('div');
            candidateDiv.className = 'form-check';
            
            const candidateRadio = document.createElement('input');
            candidateRadio.className = 'form-check-input';
            candidateRadio.type = 'radio';
            candidateRadio.name = `poll-${poll.id}-candidates`;
            candidateRadio.value = candidate.id;
            candidateDiv.appendChild(candidateRadio);
            
            const candidateLabel = document.createElement('label');
            candidateLabel.className = 'form-check-label';
            candidateLabel.htmlFor = `poll-${poll.id}-candidate-${candidate.id}-radio`;
            candidateLabel.textContent = candidate.name;
            candidateDiv.appendChild(candidateLabel);
            
            pollDiv.appendChild(candidateDiv);
          });
          
          // Add event listener to the poll radio buttons
          const pollRadios = pollDiv.querySelectorAll('input[name="poll-' + poll.id + '-candidates"]');
          pollRadios.forEach(radio => {
            radio.addEventListener('change', () => {
              const selectedValue = document.querySelector('input[name="poll-' + poll.id + '-candidates"]:checked').value;
              createVote(poll.id, selectedValue);
            });
          });
          
          pollListContainer.appendChild(pollDiv);
        } catch (error) {
          console.log(error);

     
      }
    }
    
    async function createVote(pollId, candidateId) {
      try {
        const response = await fetch(`http://127.0.0.1:8000/polls/${pollId}/candidates/${candidateId}/vote/`, {
          method: 'POST',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          },
        });
        const data = await response.json();
        
        console.log(data); // Display the result of the vote
      } catch (error) {
        console.log('Error:', error);
      }
    }
    
    fetchPolls();
  </script>
